<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¾é¾ åœˆåœˆå‰å‰ (æœ€çµ‚ç‰ˆ)</title>
    
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- è¼‰å…¥å­—é«” -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* * åŸºæœ¬æ¨£å¼å’ŒèƒŒæ™¯è¨­å®š
         * ----------------------------------------------------
         */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            position: relative;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            overflow: hidden; /* éš±è—æ»¾å‹•æ¢ */
            background-color: #111; /* æ·±è‰²èƒŒæ™¯åº•è‰² */
        }

        #backgroundImage {
            position: absolute; /* æ”¹ç‚ºçµ•å°å®šä½ï¼Œä»¥ä¾¿JSæ§åˆ¶ */
            width: 100%; /* åˆå§‹å¯¬åº¦ */
            height: 100%; /* åˆå§‹é«˜åº¦ */
            background-image: url('https://firebasestorage.googleapis.com/v0/b/ooxx-62994.firebasestorage.app/o/image.png?alt=media&token=580e06ea-9a0d-4946-8f79-6949da8025c6');
            background-size: contain; /* ğŸ”¥ æ›´æ”¹ï¼šå¾ cover æ”¹ç‚º contain */
            background-repeat: no-repeat; /* ğŸ”¥ æ–°å¢ï¼šç¢ºä¿åœ–ç‰‡ä¸é‡è¤‡ */
            background-position: center center; /* JS å°‡æ§åˆ¶é€™å€‹ */
            will-change: transform, background-position; /* æ•ˆèƒ½å„ªåŒ– */
            cursor: grab; /* æ‹–å‹•æ‰‹å‹¢ */
            transition: transform 0.05s ease-out; /* ç¸®æ”¾æ™‚çš„å¹³æ»‘éæ¸¡ */
        }

        #backgroundImage:active {
            cursor: grabbing;
        }

        /* * éŠæˆ²å€å¡Š (å¯æ‹–å‹•å’Œèª¿æ•´å¤§å°)
         * ----------------------------------------------------
         */
        #gameContainer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* åˆå§‹ç½®ä¸­ */
            
            /* ğŸ”¥ ç§»é™¤ min-widthï¼Œæ”¹ç‚ºå›ºå®šå¯¬åº¦ */
            width: 300px; /* å›ºå®šå¯¬åº¦ 300px */
            
            /* è®“å­å…ƒç´ (æ£‹ç›¤)å¯ä»¥åŸºæ–¼æ­¤å®¹å™¨èª¿æ•´å¤§å° */
            display: flex;
            flex-direction: column;
            
            /* æ•ˆèƒ½å„ªåŒ– */
            will-change: transform, width, height;
        }

        /* * æ§åˆ¶é¢æ¿ (éŠæˆ²å€çš„ "é ­éƒ¨")
         * ----------------------------------------------------
         */
        #controlPanel {
            width: 100%;
            background-color: rgba(22, 32, 53, 0.85); /* æ·±è—è‰²åŠé€æ˜ */
            backdrop-filter: blur(10px);
            border-radius: 12px; /* ğŸ”¥ æ›´æ”¹ï¼šè®“æ‰€æœ‰è§’è½éƒ½æ˜¯åœ“è§’ */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            padding: 0.75rem; /* ğŸ”¥ æ›´æ”¹ï¼šçµ±ä¸€çš„å…§è· */
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            cursor: move; /* æ‹–å‹•æ‰‹å‹¢ */
            
            /* ğŸ”¥ æ›´æ”¹ï¼šä½¿ç”¨ Flexbox å‚ç›´ä½ˆå±€ */
            display: flex;
            flex-direction: column;
            gap: 0.75rem; /* ğŸ”¥ æ–°å¢ï¼šè¡Œä¹‹é–“çš„é–“è· */
        }

        /* ğŸ”¥ æ–°å¢ï¼šæ§åˆ¶é¢æ¿é ‚éƒ¨è¡Œ (ç‹€æ…‹ + æŒ‰éˆ•) */
        .control-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        /* ç‹€æ…‹æ–‡å­— (é¾é¾æ€è€ƒä¸­...) */
        #statusMessage {
            font-weight: 600;
            font-size: 1rem; /* ä½¿ç”¨ rem å–®ä½ä»¥ä¾¿ç¸®æ”¾ */
            white-space: nowrap; /* é˜²æ­¢æ›è¡Œ */
            color: #e0e0e0;
            margin-right: 8px; /* å’ŒæŒ‰éˆ•çµ„ä¿æŒä¸€é»è·é›¢ */
        }
        
        /* æŒ‰éˆ•ç¾¤çµ„ */
        .button-group {
            display: flex;
            gap: 0.5rem; /* æŒ‰éˆ•é–“è· */
            align-items: center;
        }

        /* æ§åˆ¶é¢æ¿ä¸­çš„æŒ‰éˆ• */
        .control-button {
            background-color: rgba(255, 255, 255, 0.1);
            color: #f0f0f0;
            font-weight: 500;
            padding: 0.25rem 0.5rem; /* è¼ƒå°çš„æŒ‰éˆ• */
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            font-size: 0.8rem; /* ä½¿ç”¨ rem å–®ä½ */
            white-space: nowrap;
        }
        
        .control-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .control-button:active {
            transform: scale(0.95);
        }
        
        /* ğŸ”¥ æ–°å¢ï¼šAPI Key è¼¸å…¥æ¡†çš„æ¨£å¼ */
        .api-key-row {
            display: flex;
            align-items: center;
            width: 100%;
            gap: 0.5rem;
        }
        .api-key-label {
            font-size: 0.8rem;
            color: #ccc;
            white-space: nowrap;
        }
        #apiKeyInput {
            flex-grow: 1; /* å¡«æ»¿å‰©é¤˜ç©ºé–“ */
            background-color: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: white;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            font-family: monospace; /* é©åˆé¡¯ç¤º Key */
        }
        #apiKeyInput::placeholder {
            color: #888;
        }

        /* ğŸ”¥ ç§»é™¤ï¼šåˆªé™¤ .resize-button æ¨£å¼ */


        /* * éŠæˆ²æ£‹ç›¤ (æ ¼å­)
         * ----------------------------------------------------
         */
        #board {
            /* display: grid; */ /* ğŸ”¥ ç§»é™¤ï¼šé€™äº›æ¨£å¼æ˜¯å¤šé¤˜çš„ */
            /* grid-template-columns: repeat(3, 1fr); */ /* ğŸ”¥ ç§»é™¤ */
            /* grid-template-rows: repeat(3, 1fr); */ /* ğŸ”¥ ç§»é™¤ */
            /* gap: 0.5rem; */ /* ğŸ”¥ ç§»é™¤ */
            
            width: 100%; /* å¡«æ»¿ gameContainer */
            
            /* * é—œéµï¼šè®“æ£‹ç›¤ä¿æŒ 1:1 çš„é•·å¯¬æ¯” 
             * padding-top: 100% æ„æ€æ˜¯ "padding æ•¸å€¼ç­‰æ–¼å¯¬åº¦çš„ 100%"
             * é€™æœƒæ’é–‹ä¸€å€‹ 1:1 çš„ç©ºé–“ï¼Œç„¶å¾Œæˆ‘å€‘ç”¨ position: absolute æŠŠæ ¼å­æ”¾å›å»ã€‚
             */
            /* height: 0; */ /* ğŸ”¥ ç§»é™¤ï¼šæ”¹ç”¨ aspect-ratio */
            /* padding-top: 100%; */ /* ğŸ”¥ ç§»é™¤ï¼šæ”¹ç”¨ aspect-ratio */
            aspect-ratio: 1 / 1; /* ğŸ”¥ æ–°å¢ï¼šä½¿ç”¨ç¾ä»£ CSS æ–¹å¼ä¿æŒ 1:1 */
            
            position: relative;
        }
        
        /* * æ£‹ç›¤å…§å®¹ (æ ¼å­çš„çˆ¶å®¹å™¨)
         * æˆ‘å€‘éœ€è¦é€™å€‹ div æ‰èƒ½åœ¨ 1:1 çš„ padding ç©ºé–“ä¸Šå®šä½
         */
        .board-content {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0; /* ç§»é™¤ gap */
            
            /* æ–°å¢ï¼šç‚ºå®¹å™¨åŠ ä¸Šå¤–æ¡†ï¼Œé€™æœƒæ˜¯ä¹å®®æ ¼çš„å¤–æ¡† */
            border: 2px solid rgba(0, 0, 0, 0.7); /* ğŸ”¥ æ›´æ”¹ï¼šç·šæ¢æ”¹ç‚ºé»‘è‰² */
            border-radius: 0.75rem; /* é…åˆæ ¼å­çš„åœ“è§’ */
            overflow: hidden; /* ç¢ºä¿å…§éƒ¨çš„æ ¼å­ä¸æœƒè¶…å‡ºåœ“è§’ */
        }


        /* * éŠæˆ²æ ¼å­ (X å’Œ O)
         * ----------------------------------------------------
         */
        .cell {
            background-color: rgba(255, 255, 255, 0.1); /* æ ¼å­åŠé€æ˜èƒŒæ™¯ */
            backdrop-filter: blur(5px);
            /* border-radius: 0.75rem; */ /* åœ“è§’ (ä½¿ç”¨ rem) - æ”¹ç”± NTH-CHILD æ§åˆ¶ */
            
            display: flex;
            align-items: center;
            justify-content: center;
            
            line-height: 1; /* ğŸ”¥ æ–°å¢ï¼šå›ºå®šè¡Œé«˜ï¼Œé˜²æ­¢æ–‡å­—æ’é–‹æ ¼å­ */
            overflow: hidden; /* ğŸ”¥ æ–°å¢ï¼šç¢ºä¿å…§å®¹ä¸æœƒæº¢å‡ºä¸¦æ”¹è®Šå¤§å° */
            
            font-weight: bold;
            font-size: 5rem; /* åŸºæœ¬å­—é«”å¤§å° (ä½¿ç”¨ rem)ï¼ŒJS æœƒèª¿æ•´ */
            
            /* ä¿æŒ 1:1 çš„é•·å¯¬æ¯” */
            width: 100%;
            aspect-ratio: 1 / 1; 
            
            cursor: pointer;
            transition: background-color 0.2s;
            /* border: 1px solid rgba(255, 255, 255, 0.1); */ /* ç§»é™¤èˆŠ border */

            /* æ–°å¢ï¼šåªåŠ ä¸Šå…§éƒ¨çš„ç·š */
            border-bottom: 2px solid rgba(0, 0, 0, 0.7); /* ğŸ”¥ æ›´æ”¹ï¼šç·šæ¢æ”¹ç‚ºé»‘è‰² */
            border-right: 2px solid rgba(0, 0, 0, 0.7); /* ğŸ”¥ æ›´æ”¹ï¼šç·šæ¢æ”¹ç‚ºé»‘è‰² */
        }
        
        .cell:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .cell.cursor-not-allowed {
            cursor: not-allowed;
            opacity: 0.8;
        }

        .cell-x { color: #ef4444; } /* ç´…è‰² */
        .cell-o { color: #3b82f6; } /* è—è‰² */

        /* * è®€å–é®ç½© (é¾é¾æ€è€ƒä¸­...)
         * ----------------------------------------------------
         */
        #aiLoading {
            position: absolute;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
            
            display: flex; /* æ”¹ç‚º flex */
            flex-direction: column; /* å‚ç›´æ’åˆ— */
            align-items: center;
            justify-content: center;
            
            z-index: 10;
            border-radius: 0.75rem; /* é…åˆæ ¼å­åœ“è§’ */
            
            /* åˆå§‹éš±è— */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }

        #aiLoading.show {
            opacity: 1;
            visibility: visible;
        }
        
        /* è®€å–å‹•ç•« */
        .loader {
            width: 3rem; /* (ä½¿ç”¨ rem) */
            height: 3rem; /* (ä½¿ç”¨ rem) */
            border: 4px solid #FFF;
            border-bottom-color: #3b82f6; /* è—è‰² */
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: spin 1s linear infinite;
            margin-bottom: 0.75rem; /* å’Œæ–‡å­—çš„é–“è· */
        }
        
        /* è®€å–æ–‡å­— */
        #loadingText {
            color: white;
            font-size: 1rem; /* (ä½¿ç”¨ rem) */
            font-weight: 600;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ğŸ”¥ ç§»é™¤ï¼šåˆªé™¤ #resizeHandle æ¨£å¼ */
        
        /* * æ–°å¢ï¼šèƒŒæ™¯ç¸®æ”¾æŒ‰éˆ•
         * ----------------------------------------------------
         */
        .zoom-button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(22, 32, 53, 0.85);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .zoom-button:hover { 
            background-color: rgba(42, 52, 73, 1); 
        }
        .zoom-button:active { 
            transform: scale(0.9); 
        }

        /* --- æ–°å¢ï¼šä¹å®®æ ¼å…§ç·š (ç§»é™¤å¤–æ¡†) --- */
        .cell:nth-child(3n) { /* å³é‚Šçš„æ¬„ä½ */
            border-right: none;
        }
        .cell:nth-child(n+7) { /* ä¸‹é¢çš„é‚£æ’ */
            border-bottom: none;
        }
        
        /* èª¿æ•´æ ¼å­çš„åœ“è§’ï¼Œåªæœ‰è§’è½çš„æ ¼å­éœ€è¦ */
        .cell:nth-child(1) { border-top-left-radius: 0.6rem; }
        .cell:nth-child(3) { border-top-right-radius: 0.6rem; }
        .cell:nth-child(7) { border-bottom-left-radius: 0.6rem; }
        .cell:nth-child(9) { border-bottom-right-radius: 0.6rem; }

    </style>
</head>
<body class="p-0 m-0">

    <!-- èƒŒæ™¯åœ–ç‰‡ -->
    <div id="backgroundImage"></div>

    <!-- éŠæˆ²å€å¡Š (å¯æ‹–å‹•å’Œèª¿æ•´å¤§å°) -->
    <div id="gameContainer">
        
        <!-- æ§åˆ¶é¢æ¿ (æ‹–å‹•çš„æŠŠæ‰‹) -->
        <div id="controlPanel">
            <!-- é ‚éƒ¨è¡Œï¼šç‹€æ…‹ + æŒ‰éˆ• -->
            <div class="control-top-row">
                <div id="statusMessage" class="text-base font-semibold text-gray-200 truncate">
                    è¼ªåˆ°ä½ äº†
                </div>
                <div class="button-group">
                    <button id="playerToggleBtn" class="control-button">
                        ä½  (X) å…ˆæ‰‹
                    </button>
                    <button id="resetButton" class="control-button">
                        é‡è¨­
                    </button>
                </div>
            </div>
            
            <!-- ğŸ”¥ æ–°å¢ï¼šAPI Key è¼¸å…¥è¡Œ -->
            <div class="api-key-row">
                <label for="apiKeyInput" class="api-key-label">API Key:</label>
                <input type="password" id="apiKeyInput" placeholder="è²¼ä¸Šä½ è‡ªå·±çš„ API Key">
            </div>
        </div>

        <!-- éŠæˆ²æ£‹ç›¤ -->
        <div id="board">
            <div class="board-content">
                <!-- æ ¼å­å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
            </div>
            
            <!-- è®€å–é®ç½© -->
            <div id="aiLoading">
                <div class="loader"></div>
                <div id="loadingText">é¾é¾æ€è€ƒä¸­...</div>
            </div>
        </div>
        
        <!-- ğŸ”¥ ç§»é™¤ï¼šèª¿æ•´å¤§å°çš„æ‹–æ›³é» -->
    </div>
    
    <!-- æ–°å¢ï¼šèƒŒæ™¯ç¸®æ”¾æ§åˆ¶æŒ‰éˆ• -->
    <div id="bgZoomControls" style="position: fixed; bottom: 20px; left: 20px; z-index: 100; display: flex; flex-direction: column; gap: 8px;">
        <button id="bgZoomInBtn" class="zoom-button">+</button>
        <button id="bgZoomOutBtn" class="zoom-button">-</button>
    </div>

    <!-- 
      * è¼‰å…¥ JavaScript
      * æ‰€æœ‰çš„ç¨‹å¼é‚è¼¯ç¾åœ¨éƒ½åˆä½µåˆ°é€™ä¸€å€‹æª”æ¡ˆä¸­
    -->
    <script type="module">
        /* * AI åœˆåœˆå‰å‰ (æœ€çµ‚ç‰ˆ) - JavaScript ç¨‹å¼é‚è¼¯
         * ----------------------------------------------------
         */

        // --- Gemini API è¨­å®š ---
        let apiKey = "AIzaSyBM0BBCpb_ctviUert_oaMOvGmPLSwYSd0"; // ğŸ”¥ æ›´æ”¹ï¼šæ‚¨çš„ API é‡‘é‘° (const æ”¹ç‚º let)
        // ğŸ”¥ ç§»é™¤ï¼šconst geminiApiUrlï¼Œæˆ‘å€‘å°‡åœ¨å‡½å¼å…§å‹•æ…‹ç”¢ç”Ÿ

        // --- DOM å…ƒç´  ---
        const body = document.body;
        const bgImage = document.getElementById('backgroundImage');
        const gameContainer = document.getElementById('gameContainer');
        const controlPanel = document.getElementById('controlPanel');
        const statusMessageEl = document.getElementById('statusMessage');
        const boardEl = document.getElementById('board').querySelector('.board-content');
        const aiLoadingEl = document.getElementById('aiLoading');
        const resetButton = document.getElementById('resetButton');
        const playerToggleBtn = document.getElementById('playerToggleBtn');
        const loadingTextEl = document.getElementById('loadingText'); // æŠ“å–è®€å–æ–‡å­—å…ƒç´ 
        const apiKeyInput = document.getElementById('apiKeyInput'); // ğŸ”¥ æ–°å¢ï¼šAPI Key è¼¸å…¥æ¡†
        
        // æ–°å¢çš„ DOM å…ƒç´ 
        const bgZoomInBtn = document.getElementById('bgZoomInBtn');
        const bgZoomOutBtn = document.getElementById('bgZoomOutBtn');
        /* ğŸ”¥ ç§»é™¤ï¼šgameResizeInBtn, gameResizeOutBtn */


        // --- éŠæˆ²ç‹€æ…‹ ---
        let board = Array(9).fill('');
        let humanPlayer = 'X'; // ç©å®¶é è¨­ç‚º 'X'
        let aiPlayer = 'O';    // AI é è¨­ç‚º 'O'
        let currentPlayer = 'X'; // 'X' æ°¸é å…ˆæ‰‹
        let gameActive = true;
        let isAiThinking = false; // AI æ€è€ƒä¸­æ¨™è¨˜

        // --- éŠæˆ²å‹åˆ©çµ„åˆ ---
        const winningCombos = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8], // æ©«æ’
            [0, 3, 6], [1, 4, 7], [2, 5, 8], // ç›´æ’
            [0, 4, 8], [2, 4, 6]  // æ–œç·š
        ];

        // --- ç•«é¢äº’å‹•è®Šæ•¸ ---
        // èƒŒæ™¯å¹³ç§»
        let isPanning = false;
        let bgPosX = 50; // èƒŒæ™¯ X ä½ç½® (ç™¾åˆ†æ¯”)
        let bgPosY = 50; // èƒŒæ™¯ Y ä½ç½® (ç™¾åˆ†æ¯”)
        let panStartX = 0;
        let panStartY = 0;

        // èƒŒæ™¯ç¸®æ”¾
        let bgScale = 1; // 1 = 100%
        const minScale = 0.3;
        const maxScale = 4;

        // éŠæˆ²å€æ‹–å‹•
        let isDraggingGame = false;
        let gameDragStartX = 0;
        let gameDragStartY = 0;
        let gameOffsetX = 0;
        let gameOffsetY = 0;

        /* ğŸ”¥ ç§»é™¤ï¼šéŠæˆ²å€èª¿æ•´å¤§å°ç›¸é—œè®Šæ•¸ */
        // let isResizing = false;
        // let gameWidth = 300; 
        // const minGameWidth = 200;
        // const maxGameWidth = 800;

        /* * ----------------------------------------------------
         * ä¸»è¦éŠæˆ²é‚è¼¯
         * ----------------------------------------------------
         */

        // --- éŠæˆ²åˆå§‹åŒ– ---
        function initializeGame() {
            board = Array(9).fill('');
            gameActive = true;
            isAiThinking = false;
            currentPlayer = 'X'; // X æ°¸é å…ˆæ‰‹
            aiLoadingEl.classList.remove('show');
            renderBoard();
            updateStatusMessage();

            // æª¢æŸ¥æ˜¯å¦è¼ªåˆ° AI å…ˆæ‰‹
            if (currentPlayer === aiPlayer) {
                handleAITurn(); // å¦‚æœ AI æ˜¯ 'X'ï¼ŒAI å…ˆæ‰‹
            }
        }

        // --- æ¸²æŸ“æ£‹ç›¤ ---
        function renderBoard() {
            boardEl.innerHTML = ''; // æ¸…ç©ºæ£‹ç›¤
            
            board.forEach((cell, index) => {
                const cellEl = document.createElement('div');
                cellEl.className = 'cell';
                
                if (cell === 'X') {
                    cellEl.textContent = 'X';
                    cellEl.classList.add('cell-x');
                } else if (cell === 'O') {
                    cellEl.textContent = 'O';
                    cellEl.classList.add('cell-o');
                }
                
                // åªæœ‰åœ¨è¼ªåˆ°ç©å®¶ã€æ ¼å­æ˜¯ç©ºçš„ã€éŠæˆ²é‚„åœ¨é€²è¡Œæ™‚ï¼Œæ‰åŠ ä¸Šé»æ“Šäº‹ä»¶
                if (gameActive && cell === '' && currentPlayer === humanPlayer && !isAiThinking) {
                    cellEl.onclick = () => handleCellClick(index);
                } else {
                    cellEl.classList.add('cursor-not-allowed');
                }
                
                boardEl.appendChild(cellEl);
            });

            /* ğŸ”¥ ç§»é™¤ï¼šä¸å†éœ€è¦å‹•æ…‹æ›´æ–°å­—é«”å¤§å° */
            // updateBoardFontSize();
        }

        // --- æ›´æ–°ç‹€æ…‹è¨Šæ¯ ---
        function updateStatusMessage() {
            if (!gameActive) {
                // éŠæˆ²çµæŸçš„è¨Šæ¯å·²åœ¨ checkGameResult ä¸­è™•ç†
                return;
            }
            
            if (isAiThinking) {
                // ğŸ”¥ æ›´æ”¹ #2ï¼šAI æ€è€ƒä¸­çš„æ–‡å­—
                loadingTextEl.textContent = 'é¾é¾æ€è€ƒä¸­...'; // æ›´æ–°é®ç½©ä¸Šçš„æ–‡å­—
                aiLoadingEl.classList.add('show');
                statusMessageEl.textContent = 'é¾é¾æ€è€ƒä¸­...'; // æ›´æ–°æ§åˆ¶é¢æ¿çš„æ–‡å­—
            } else {
                aiLoadingEl.classList.remove('show');
                if (currentPlayer === humanPlayer) {
                    statusMessageEl.textContent = 'è¼ªåˆ°ä½ äº†';
                } else {
                    // é€™ä¸æ‡‰è©²ç™¼ç”Ÿï¼Œå› ç‚º AI æ€è€ƒå®Œå°±æœƒæ›äºº
                    statusMessageEl.textContent = 'è¼ªåˆ° é¾é¾'; /* ğŸ”¥ æ›´æ”¹ */
                }
            }
        }


        // --- ç©å®¶é»æ“Šè™•ç† ---
        function handleCellClick(index) {
            if (!gameActive || board[index] !== '' || currentPlayer !== humanPlayer || isAiThinking) {
                return;
            }

            // ç©å®¶ä¸‹æ£‹
            board[index] = humanPlayer;
            currentPlayer = aiPlayer;
            renderBoard();

            // æª¢æŸ¥çµæœ
            if (checkGameResult()) {
                return;
            }
            
            // è¼ªåˆ° AI
            isAiThinking = true;
            updateStatusMessage();
            
            // ğŸ”¥ æ›´æ”¹ #1ï¼šç§»é™¤ 500ms å»¶é²
            // ç«‹å³å‘¼å« AIï¼Œä¸å†ç­‰å¾…
            handleAITurn();
        }

        // --- AI å›åˆè™•ç† ---
        async function handleAITurn() {
            isAiThinking = true;
            updateStatusMessage();

            try {
                const move = await getGeminiMove();
                if (gameActive) { // ç¢ºä¿åœ¨ AI æ€è€ƒæœŸé–“éŠæˆ²æ²’æœ‰è¢«é‡è¨­
                    executeMove(move);
                }
            } catch (error) {
                console.error("Gemini API å‘¼å«å¤±æ•—:", error);
                // API å¤±æ•—æ™‚ï¼Œä½¿ç”¨å‚™ç”¨ï¼ˆéš¨æ©Ÿï¼‰çš„ AI ç­–ç•¥
                if (gameActive) {
                    executeFallbackMove();
                }
            } finally {
                if (gameActive) {
                    isAiThinking = false;
                    // æª¢æŸ¥ AI ä¸‹å®Œå¾ŒéŠæˆ²æ˜¯å¦çµæŸ
                    if (!checkGameResult()) {
                        // éŠæˆ²æœªçµæŸï¼Œæ›´æ–°ç‹€æ…‹
                        currentPlayer = humanPlayer;
                        renderBoard(); // é‡ç¹ªæ£‹ç›¤ä»¥å•Ÿç”¨é»æ“Š
                        updateStatusMessage();
                    }
                }
            }
        }

        // --- å‘¼å« Gemini API å–å¾— AI æ­¥é©Ÿ ---
        async function getGeminiMove() {
            // ğŸ”¥ æ–°å¢ï¼šåœ¨å‡½å¼å…§å‹•æ…‹å»ºç«‹ API URL
            const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            // ç³»çµ±æç¤ºï¼šå®šç¾© AI çš„è§’è‰²å’Œè¦å‰‡
            const systemPrompt = `ä½ æ˜¯å€‹å°ˆæ¥­çš„åœˆåœˆå‰å‰ï¼ˆTic-Tac-Toeï¼‰ç©å®¶ã€‚ä½ æ‰®æ¼” '${aiPlayer}'ï¼Œç©å®¶æ‰®æ¼” '${humanPlayer}'ã€‚ä½ å¿…é ˆåªå›å‚³ä½ ä¸‹ä¸€æ­¥æ£‹çš„ç´¢å¼•ï¼ˆ0åˆ°8ä¹‹é–“ï¼‰ã€‚ä¸è¦åŒ…å«ä»»ä½•å…¶ä»–æ–‡å­—ã€è§£é‡‹æˆ–å•å€™ã€‚ä½ çš„ç›®æ¨™æ˜¯è´ï¼Œå¦‚æœä¸è¡Œå°±å¹³å±€ã€‚åªèƒ½é¸æ“‡ç©ºæ ¼ã€‚`; /* ğŸ”¥ æ›´æ”¹ "AI" ç‚º "ç©å®¶" */
            
            // ä½¿ç”¨è€…æç¤ºï¼šæä¾›ç•¶å‰ç‹€æ…‹
            const userQuery = `ç›®å‰æ£‹ç›¤ (ç´¢å¼• 0-8): [${board.map(c => `'${c}'`).join(', ')}]\nè¼ªåˆ°ä½ äº† (${aiPlayer})ã€‚ä½ çš„ä¸‹ä¸€æ­¥æ˜¯ä»€éº¼ï¼Ÿ`;

            const payload = {
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                contents: [
                    { parts: [{ text: userQuery }] }
                ]
            };

            const response = await fetch(geminiApiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`API error: ${response.status} ${response.statusText}`);
            }

            const result = await response.json();
            const moveText = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim();

            if (!moveText) {
                throw new Error("API å›å‚³äº†ç„¡æ•ˆçš„å…§å®¹");
            }

            const moveIndex = parseInt(moveText, 10);
            if (!isNaN(moveIndex) && moveIndex >= 0 && moveIndex <= 8 && board[moveIndex] === '') {
                return moveIndex;
            } else {
                console.warn("Gemini å›å‚³äº†ç„¡æ•ˆçš„æ­¥é©Ÿ:", moveText);
                throw new Error("Gemini returned an invalid move");
            }
        }

        // --- å‚™ç”¨çš„ AI ç­–ç•¥ (éš¨æ©Ÿé¸æ“‡) ---
        function executeFallbackMove() {
            console.log("å•Ÿç”¨å‚™ç”¨ é¾é¾ (éš¨æ©Ÿ)"); /* ğŸ”¥ æ›´æ”¹ */
            const emptyCells = board
                .map((cell, index) => (cell === '' ? index : null))
                .filter(index => index !== null);
            
            if (emptyCells.length > 0) {
                const randomIndex = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                executeMove(randomIndex);
            }
        }

        // --- åŸ·è¡Œ AI çš„æ­¥é©Ÿ ---
        function executeMove(index) {
            if (index === undefined || index === null || board[index] !== '') {
                // å¦‚æœ AI æ²’çµ¦æœ‰æ•ˆæ­¥é©Ÿï¼Œæˆ–å‚™ç”¨ AI ä¹Ÿæ‰¾ä¸åˆ°åœ°æ–¹ä¸‹
                if(gameActive) executeFallbackMove();
                return;
            }
            board[index] = aiPlayer;
            // (ä¸è¦åœ¨é€™è£¡åˆ‡æ› currentPlayer æˆ– renderBoardï¼Œ
            //  handleAITurn çš„ finally å€å¡Šæœƒçµ±ä¸€è™•ç†)
        }

        // --- æª¢æŸ¥éŠæˆ²çµæœ ---
        function checkGameResult() {
            let roundWon = false;
            for (const combo of winningCombos) {
                const [a, b, c] = combo;
                if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                    gameActive = false;
                    const winner = board[a];
                    statusMessageEl.textContent = winner === humanPlayer ? 'ä½ è´äº†ï¼ğŸ‰' : 'é¾é¾ è´äº†ï¼'; /* ğŸ”¥ æ›´æ”¹ */
                    roundWon = true;
                    aiLoadingEl.classList.remove('show'); // éŠæˆ²çµæŸï¼Œéš±è—è®€å–
                    renderBoard(); // é‡ç¹ªæ£‹ç›¤ä»¥ç§»é™¤é»æ“Šäº‹ä»¶
                    break;
                }
            }

            if (!roundWon && !board.includes('')) {
                gameActive = false;
                statusMessageEl.textContent = 'å¹³æ‰‹ï¼';
                aiLoadingEl.classList.remove('show');
                return true;
            }

            return roundWon;
        }

        // --- åˆ‡æ›ç©å®¶è§’è‰² (åŠŸèƒ½ 4) ---
        function handlePlayerChange() {
            if (humanPlayer === 'X') {
                humanPlayer = 'O';
                aiPlayer = 'X';
                playerToggleBtn.textContent = 'ä½  (O) å¾Œæ‰‹';
            } else {
                humanPlayer = 'X';
                aiPlayer = 'O';
                playerToggleBtn.textContent = 'ä½  (X) å…ˆæ‰‹';
            }
            
            // åªæœ‰åœ¨éŠæˆ²çµæŸæˆ–å‰›é–‹å§‹æ™‚åˆ‡æ›æ‰ç«‹å³é‡è¨­
            // å¦‚æœéŠæˆ²ç©åˆ°ä¸€åŠï¼Œå°±ç­‰ä¸‹æ¬¡æŒ‰é‡è¨­
            if (!gameActive || board.every(c => c === '')) {
                initializeGame();
            }
        }

        /* * ----------------------------------------------------
         * ç•«é¢äº’å‹•é‚è¼¯ (æ‹–å‹•, ç¸®æ”¾, èª¿æ•´å¤§å°)
         * ----------------------------------------------------
         */

        // --- 1. èƒŒæ™¯å¹³ç§» (Pan) ---
        function startPan(e) {
            // ç¢ºä¿é»æ“Šçš„æ˜¯èƒŒæ™¯æœ¬èº«ï¼Œè€Œä¸æ˜¯éŠæˆ²å€æˆ–æŒ‰éˆ•
            if (e.target === bgImage) {
                isPanning = true;
                panStartX = e.clientX;
                panStartY = e.clientY;
                bgImage.style.cursor = 'grabbing';
            }
        }

        function doPan(e) {
            if (!isPanning) return;
            
            const deltaX = e.clientX - panStartX;
            const deltaY = e.clientY - panStartY;
            
            // æ›´æ–°èµ·å§‹é»
            panStartX = e.clientX;
            panStartY = e.clientY;
            
            const containerWidth = window.innerWidth;
            const containerHeight = window.innerHeight;
            
            // é€Ÿåº¦èª¿æ•´ (é™¤ä»¥ scale è®“ç¸®å°æ™‚æ‹–æ›´å¿«ï¼Œæ”¾å¤§æ™‚æ‹–æ›´æ…¢ï¼Œç¬¦åˆç›´è¦º)
            bgPosX += (deltaX / containerWidth) * 100 / bgScale;
            bgPosY += (deltaY / containerHeight) * 100 / bgScale;

            updateBackgroundTransform();
        }

        function endPan(e) {
            isPanning = false;
            bgImage.style.cursor = 'grab';
        }

        // --- 2. èƒŒæ™¯ç¸®æ”¾ (Zoom - æ»¾è¼ª) ---
        function handleZoom(e) {
            // ç¢ºä¿æ»¾å‹•äº‹ä»¶ç™¼ç”Ÿåœ¨èƒŒæ™¯ä¸Šï¼Œè€Œä¸æ˜¯éŠæˆ²å€
            if (!gameContainer.contains(e.target)) {
                e.preventDefault(); // é˜²æ­¢é é¢æ»¾å‹•

                const scaleAmount = -e.deltaY * 0.001; // æ»¾å‹•éˆæ•åº¦
                const oldScale = bgScale;

                bgScale += scaleAmount * bgScale; // è¶Šæ”¾å¤§ï¼Œç¸®æ”¾è¶Šå¿«
                bgScale = Math.max(minScale, Math.min(maxScale, bgScale)); // é™åˆ¶ç¸®æ”¾ç¯„åœ

                // --- ä»¥æ»‘é¼ ç‚ºä¸­å¿ƒç¸®æ”¾ ---
                const mouseX = (e.clientX / window.innerWidth) * 100;
                const mouseY = (e.clientY / window.innerHeight) * 100;

                bgPosX -= (mouseX - bgPosX) * (bgScale / oldScale - 1);
                bgPosY -= (mouseY - bgPosY) * (bgScale / oldScale - 1);
                
                updateBackgroundTransform();
            }
        }

        // --- 3. éŠæˆ²å€æ‹–å‹• ---
        function startGameDrag(e) {
            // ç¢ºä¿é»æ“Šçš„æ˜¯æ§åˆ¶é¢æ¿ï¼Œä¸”ä¸æ˜¯æŒ‰éˆ•
            if (e.target.closest('button')) {
                return; // å¦‚æœé»æ“Šçš„æ˜¯æŒ‰éˆ•ï¼Œä¸æ‹–å‹•
            }
            
            isDraggingGame = true;
            
            const transform = window.getComputedStyle(gameContainer).transform;
            if (transform === 'none') {
                gameOffsetX = 0;
                gameOffsetY = 0;
            } else {
                const matrix = new DOMMatrix(transform);
                gameOffsetX = matrix.m41; // tx
                gameOffsetY = matrix.m42; // ty
            }
            
            gameDragStartX = e.clientX - gameOffsetX;
            gameDragStartY = e.clientY - gameOffsetY;
            
            controlPanel.style.cursor = 'move';
            body.style.userSelect = 'none'; // é˜²æ­¢æ‹–å‹•æ™‚é¸å–æ–‡å­—
        }

        function doGameDrag(e) {
            if (!isDraggingGame) return;

            const newX = e.clientX - gameDragStartX;
            const newY = e.clientY - gameDragStartY;
            
            gameContainer.style.transform = `translate(${newX}px, ${newY}px)`;
        }

        function endGameDrag(e) {
            isDraggingGame = false;
            controlPanel.style.cursor = 'move';
            body.style.userSelect = '';
        }

        /* ğŸ”¥ ç§»é™¤ï¼šç§»é™¤ startResize, doResize, endResize æ•´å€‹å€å¡Š */

        // --- è¼”åŠ©å‡½å¼ï¼šæ›´æ–°èƒŒæ™¯ Transform ---
        function updateBackgroundTransform() {
            bgImage.style.backgroundPosition = `${bgPosX}% ${bgPosY}%`;
            bgImage.style.transform = `scale(${bgScale})`;
        }

        /* ğŸ”¥ ç§»é™¤ï¼šç§»é™¤ updateBoardFontSize æ•´å€‹å‡½å¼ */

        
        /* ğŸ”¥ ç§»é™¤ï¼šç§»é™¤ resizeGame æ•´å€‹å‡½å¼ */


        /* * ----------------------------------------------------
         * ç¶å®šäº‹ä»¶ç›£è½å™¨
         * ----------------------------------------------------
         */

        // éŠæˆ²æŒ‰éˆ•
        resetButton.onclick = initializeGame;
        playerToggleBtn.onclick = handlePlayerChange;

        // èƒŒæ™¯å¹³ç§»
        bgImage.addEventListener('mousedown', startPan);
        body.addEventListener('mousemove', doPan);
        body.addEventListener('mouseup', endPan);
        body.addEventListener('mouseleave', endPan); // ç§»å‡ºè¦–çª—ä¹Ÿåœæ­¢

        // èƒŒæ™¯ç¸®æ”¾ (æ»¾è¼ª)
        body.addEventListener('wheel', handleZoom, { passive: false }); // {passive: false} æ‰èƒ½ preventDefault

        // éŠæˆ²å€æ‹–å‹•
        controlPanel.addEventListener('mousedown', startGameDrag);
        body.addEventListener('mousemove', doGameDrag);
        body.addEventListener('mouseup', endGameDrag);
        body.addEventListener('mouseleave', endGameDrag);

        /* ğŸ”¥ ç§»é™¤ï¼šéŠæˆ²å€èª¿æ•´å¤§å° (æ‹–æ›³é») çš„äº‹ä»¶ç›£è½ */
        
        // --- æ–°å¢ï¼šæŒ‰éˆ•ç¸®æ”¾/èª¿æ•´å¤§å° ---
        // èƒŒæ™¯ç¸®æ”¾æŒ‰éˆ•
        bgZoomInBtn.onclick = () => zoomInBackground(1.2);  // æ”¾å¤§ 20%
        bgZoomOutBtn.onclick = () => zoomInBackground(0.8); // ç¸®å° 20%

        /* ğŸ”¥ ç§»é™¤ï¼šéŠæˆ²å€èª¿æ•´å¤§å°æŒ‰éˆ•çš„äº‹ä»¶ç›£è½ */

        // ğŸ”¥ æ–°å¢ï¼šAPI Key è¼¸å…¥æ¡†äº‹ä»¶ç›£è½
        apiKeyInput.value = apiKey; // è¼‰å…¥æ™‚è‡ªå‹•å¡«å…¥
        apiKeyInput.addEventListener('input', (e) => {
            apiKey = e.target.value; // ç•¶ä½¿ç”¨è€…è¼¸å…¥æ™‚ï¼Œå³æ™‚æ›´æ–° apiKey è®Šæ•¸
        });


        // --- å•Ÿå‹•éŠæˆ² ---
        initializeGame();
        /* ğŸ”¥ ç§»é™¤ï¼šä¸å†éœ€è¦ç”¨ JS è¨­å®šå¯¬åº¦æˆ–æ›´æ–°å­—é«” */
    </script>

</body>
</html>
